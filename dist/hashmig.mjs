#!/usr/bin/env node
import e from"dotenv";import r from"prompts";import{Command as t}from"commander";import*as n from"fs";import i from"fs";import o from"mysql2";import s from"kleur";import c from"crypto";import{z as a}from"zod";import u from"@rsol/pipe";function l(){return l=Object.assign?Object.assign.bind():function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},l.apply(this,arguments)}function f(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=new Array(r);t<r;t++)n[t]=e[t];return n}function h(e,r){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(t)return(t=t.call(e)).next.bind(t);if(Array.isArray(e)||(t=function(e,r){if(e){if("string"==typeof e)return f(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?f(e,r):void 0}}(e))||r&&e&&"number"==typeof e.length){t&&(e=t);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}e.config();var g=/*#__PURE__*/function(){function e(e){this.conn=void 0,this.connect(e)}var r=e.prototype;return r.connect=function(e){this.conn=o.createConnection(e)},r.query=function(e,r){try{var t=this;return Promise.resolve(new Promise(function(n,i){var o;t.conn||i("Connection is not established"),null==(o=t.conn)||o.query(e,r,function(e,r){e?i(e):n(r)})}))}catch(e){return Promise.reject(e)}},r.execute=function(e,r){try{var t=this;return Promise.resolve(new Promise(function(n,i){var o;t.conn||i("Connection is not established"),null==(o=t.conn)||o.execute(e,r,function(e,r){e?i(e):n(r)})}))}catch(e){return Promise.reject(e)}},e}(),d=/*#__PURE__*/function(){function e(e){void 0===e&&(e=!1),this.silent=!1,this.silent=e}var r=e.prototype;return r.log=function(e){!this.silent&&console.log(s.gray().italic(e))},r.info=function(e){!this.silent&&console.log(s.green().italic(e))},r.warn=function(e){!this.silent&&console.warn(s.red().italic(e))},r.error=function(e){!this.silent&&console.error(s.red().italic(e))},r.success=function(e){!this.silent&&console.log(s.bgGreen().bold(e))},e}();function m(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}var v=/*#__PURE__*/function(){function e(e){var r;this.db=void 0,this.folder=void 0,this.database=void 0,this.table=void 0,this.logger={log:function(){},info:function(){},warn:function(){},error:function(){},success:function(){}},this.folder=(null==e?void 0:e.folder)||"./hashmig_migrations",this.table=(null==e?void 0:e.table)||"hashmig_migrations",this.database=(null==e||null==(r=e.db)?void 0:r.database)||process.env.DB_SELECT,this.initLogger(null==e?void 0:e.logger,null==e?void 0:e.silent),this.db=new g((null==e?void 0:e.db)||{port:+(process.env.DB_PORT||3306),host:process.env.DB_SERVER,database:process.env.DB_SELECT,user:process.env.DB_USERNAME,password:process.env.DB_PASSWORD,ssl:{rejectUnauthorized:!1}})}var r=e.prototype;return r.initLogger=function(e,r){r||(this.logger=this.instanceOfLoggerEngine(e||{})?e:new d)},r.instanceOfLoggerEngine=function(e){return["log","info","warn","error","success"].reduce(function(r,t){return r&&t in e},!0)},r.isMigrationsFolderExists=function(){return n.existsSync(this.folder)},r.createMigrationsFolder=function(){n.mkdirSync(this.folder)},r.getProcedures=function(){try{return Promise.resolve(this.db.query("SHOW PROCEDURE STATUS WHERE Db = '"+this.database+"'").then(function(e){return e}).then(function(e){return e.map(function(e){return{Name:e.Name,Modified:e.Modified}})}))}catch(e){return Promise.reject(e)}},r.getFunctions=function(){try{return Promise.resolve(this.db.query("SHOW FUNCTION STATUS WHERE Db = '"+this.database+"'").then(function(e){return e}).then(function(e){return e.map(function(e){return{Name:e.Name,Modified:e.Modified}})}))}catch(e){return Promise.reject(e)}},r.getProcedureSource=function(e){try{return Promise.resolve(this.db.query("SHOW CREATE PROCEDURE "+e).then(function(e){return e}).then(function(e){return e[0]["Create Procedure"]}))}catch(e){return Promise.reject(e)}},r.getFunctionSource=function(e){try{return Promise.resolve(this.db.query("SHOW CREATE FUNCTION "+e).then(function(e){return e}).then(function(e){return e[0]["Create Function"]}))}catch(e){return Promise.reject(e)}},r.isMigrationsTableExists=function(){try{return Promise.resolve(this.db.query("SHOW TABLES LIKE '"+this.table+"'").then(function(e){return e}).then(function(e){return e.length>0}))}catch(e){return Promise.reject(e)}},r.createMigrationsTable=function(){try{return Promise.resolve(this.db.query("\n        CREATE TABLE "+this.table+"\n        (\n            ID        INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,\n            FileName  VARCHAR(255)                   NOT NULL,\n            Hash      VARCHAR(312)                   NOT NULL,\n            Type      ENUM ('procedure', 'function') NOT NULL,\n            CreatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n        )\n    "))}catch(e){return Promise.reject(e)}},r.getMigrations=function(){try{var e=this;return Promise.resolve(e.db.query("\n      SELECT FileName, Hash, Type\n       FROM "+e.table+"\n       WHERE ID IN (\n          SELECT MAX(ID) FROM "+e.table+" GROUP BY FileName\n       )\n    "))}catch(e){return Promise.reject(e)}},r.initProcedures=function(e){try{var r=function(){n.length>0&&t.logger.error("     - migrations for procedures "+n.join(", ")+" not initialized")},t=this,n=[],i=0,o=E(e,function(e){i++;var r=m(function(){return Promise.resolve(t.initProcedure(e)).then(function(){t.logger.info("     "+i+". migration for procedure "+e+" initialized")})},function(r){n.push(e),t.logger.error("     "+i+". migration for procedure "+e+" not initialized: "+r.message)});if(r&&r.then)return r.then(function(){})});return Promise.resolve(o&&o.then?o.then(r):r())}catch(e){return Promise.reject(e)}},r.initProcedure=function(e){try{var r=this;return Promise.resolve(r.getProcedureSource(e)).then(function(t){t=t.replace(/DEFINER=`[^`]+`@`[^`]+`/,"");var i=r.getHash(t="DROP PROCEDURE IF EXISTS `"+e+"`;\n-- NEW_COMMAND\n"+t),o="p_"+e+".sql";return n.writeFileSync(r.folder+"/"+o,t),Promise.resolve(r.db.query("INSERT INTO "+r.table+" (FileName, Hash, Type)\n                         VALUES (?, ?, 'procedure')",[o,i])).then(function(){})})}catch(e){return Promise.reject(e)}},r.initFunctions=function(e){try{var r=function(){n.length>0&&t.logger.error("     - migrations for functions "+n.join(", ")+" not initialized")},t=this,n=[],i=0,o=E(e,function(e){i++;var r=m(function(){return Promise.resolve(t.initFunction(e)).then(function(){t.logger.info("     "+i+". migration for function "+e+" initialized")})},function(r){n.push(e),t.logger.error("     "+i+". migration for function "+e+" not initialized: "+r.message)});if(r&&r.then)return r.then(function(){})});return Promise.resolve(o&&o.then?o.then(r):r())}catch(e){return Promise.reject(e)}},r.initFunction=function(e){try{var r=this;return Promise.resolve(r.getFunctionSource(e)).then(function(t){t=t.replace(/DEFINER=`[^`]+`@`[^`]+`/,"");var i=r.getHash(t="DROP PROCEDURE IF EXISTS `"+e+"`;\n-- NEW_COMMAND\n"+t),o="f_"+e+".sql";return n.writeFileSync(r.folder+"/"+o,t),Promise.resolve(r.db.query("INSERT INTO "+r.table+" (FileName, Hash, Type)\n                         VALUES (?, ?, 'function')",[o,i])).then(function(){})})}catch(e){return Promise.reject(e)}},r.getHash=function(e){return function(e,r){void 0===r&&(r="_@#$^*_");var t=[],n=-1,i=e.replace(/[\n\r]/g," ").replace(/\t/g," ").replace(/\\'/g,r+"single"+r).replace(/\\"/g,r+"double"+r).replace(/'.*?'/g,function(e){return t.push(e),n++,""+r+n+r}).replace(/".*?"/g,function(e){return t.push(e),n++,""+r+n+r}).replace(/\s{2,}/g," ");return t.forEach(function(e,t){i=i.replace(""+r+t+r,e)}),c.createHash("sha256").update(i).digest("hex")}(e)},r.getMigrationsFiles=function(){try{for(var e,r=this,t=new Map,i=h(n.readdirSync(r.folder));!(e=i()).done;){var o=e.value,s=n.readFileSync(r.folder+"/"+o).toString(),c=r.getHash(s);t.set(c,o)}return Promise.resolve(t)}catch(e){return Promise.reject(e)}},r.getMigrationsToRun=function(e){void 0===e&&(e=!1);try{var r=this;return Promise.resolve(r.getMigrations().then(function(e){return e.reduce(function(e,r){var t=e[0],n=e[1];return t.set(r.Hash,r.FileName),n.set(r.FileName,r.Hash),[t,n]},[new Map,new Map])})).then(function(t){var n=t[0],i=t[1];return Promise.resolve(r.getMigrationsFiles()).then(function(t){for(var o,s=h(t);!(o=s()).done;){var c=o.value,a=c[0],u=c[1];if(n.has(a)&&n.get(a)===u)t.delete(a);else{var l="     + "+u+" will be migrated"+(e?" (file hash "+a+" != db hash "+(i.has(u)?i.get(u):"-")+")":"");r.logger.log(l)}}return t})})}catch(e){return Promise.reject(e)}},r.runMigrations=function(e){try{var r=function(){n.length>0&&t.logger.error("     - migrations for files "+n.join(", ")+" not completed")},t=this,n=[],i=0,o=E(e,function(e){i++;var r=m(function(){return Promise.resolve(t.migrateFile(e)).then(function(){t.logger.info("     "+i+". migration for file "+e+" completed")})},function(r){n.push(e),t.logger.error("     "+i+". migration for file "+e+" not completed: "+r.message)});if(r&&r.then)return r.then(function(){})});return Promise.resolve(o&&o.then?o.then(r):r())}catch(e){return Promise.reject(e)}},r.migrateFile=function(e){try{var r=this,t=n.readFileSync(r.folder+"/"+e).toString(),i=r.getHash(t);return Promise.resolve(r.runFileSql(t)).then(function(){return Promise.resolve(r.db.query("INSERT INTO "+r.table+" (FileName, Hash, Type)\n                         VALUES (?, ?, 'function')",[e,i])).then(function(){})})}catch(e){return Promise.reject(e)}},r.clear=function(){try{var e=this;return Promise.resolve(e.clearDb()).then(function(){e.clearFolder()})}catch(e){return Promise.reject(e)}},r.clearDb=function(){try{var e=this;return Promise.resolve(e.db.query("DROP TABLE IF EXISTS "+e.table)).then(function(){e.logger.success("--- Migrations table dropped")})}catch(e){return Promise.reject(e)}},r.clearFolder=function(){n.rmSync(this.folder,{recursive:!0,force:!0}),this.logger.success("--- Migrations folder removed")},r.runFileSql=function(e){try{var r=this,t=e.toString().split("NEW_COMMAND");return Promise.all(t.map(function(e){return e.trim()}).filter(Boolean).map(function(e){return r.db.query(e)}))}catch(e){return Promise.reject(e)}},e}();const p="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function b(e,r,t){if(!e.s){if(t instanceof y){if(!t.s)return void(t.o=b.bind(null,e,r));1&r&&(r=t.s),t=t.v}if(t&&t.then)return void t.then(b.bind(null,e,r),b.bind(null,e,2));e.s=r,e.v=t;var n=e.o;n&&n(e)}}var y=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(r,t){var n=new e,i=this.s;if(i){var o=1&i?r:t;if(o){try{b(n,1,o(this.v))}catch(e){b(n,2,e)}return n}return this}return this.o=function(e){try{var i=e.v;1&e.s?b(n,1,r?r(i):i):t?b(n,1,t(i)):b(n,2,i)}catch(e){b(n,2,e)}},n},e}();function P(e){return e instanceof y&&1&e.s}function E(e,r,t){if("function"==typeof e[p]){var n,i,o,s=e[p]();if(function e(c){try{for(;!((n=s.next()).done||t&&t());)if((c=r(n.value))&&c.then){if(!P(c))return void c.then(e,o||(o=b.bind(null,i=new y,2)));c=c.v}i?b(i,1,c):i=c}catch(e){b(i||(i=new y),2,e)}}(),s.return){var c=function(e){try{n.done||s.return()}catch(e){}return e};if(i&&i.then)return i.then(c,function(e){throw c(e)});c()}return i}if(!("length"in e))throw new TypeError("Object is not iterable");for(var a=[],u=0;u<e.length;u++)a.push(e[u]);return function(e,r,t){var n,i,o=-1;return function s(c){try{for(;++o<e.length&&(!t||!t());)if((c=r(o))&&c.then){if(!P(c))return void c.then(s,i||(i=b.bind(null,n=new y,2)));c=c.v}n?b(n,1,c):n=c}catch(e){b(n||(n=new y),2,e)}}(),n}(a,function(e){return r(a[e])},t)}var S=/*#__PURE__*/function(){function e(){}return e.getConfig=function(e){return void 0===e&&(e="./hashmig.config.json"),this.fileName=e,this.loadConfigFromFile()||this.getConfigFromEnv()||null},e.getConfigFromEnv=function(){var e={db:{port:+(process.env.DB_PORT||3306),host:process.env.DB_SERVER,database:process.env.DB_SELECT,user:process.env.DB_USERNAME,password:process.env.DB_PASSWORD,ssl:{rejectUnauthorized:!1}},folder:process.env.HASHMIG_FOLDER||"./hashmig_migrations",table:process.env.HASHMIG_TABLE||"hashmig_migrations",silent:"true"===process.env.HASHMIG_SILENT};return this.validateAndFillConfig(e)},e.loadConfigFromFile=function(){if(!i.existsSync(""+this.fileName))return null;var e=i.readFileSync(""+this.fileName).toString();return this.validateAndFillConfig(JSON.parse(e))},e.validateAndFillConfig=function(e){var r=a.object({db:a.object({port:a.string().or(a.number()),host:a.string(),database:a.string(),user:a.string(),password:a.string(),ssl:a.object({rejectUnauthorized:a.boolean().or(a.string())})}),folder:a.string(),table:a.string(),silent:a.string().or(a.boolean())});try{var t,n,i,o,s;r.parse(e);var c=a.object({db:a.object({port:a.number(),host:a.string(),database:a.string(),user:a.string(),password:a.string(),ssl:a.object({rejectUnauthorized:a.boolean()})}),folder:a.string(),table:a.string(),silent:a.boolean()}),l=(new u).addHandler("env",function(){return function(e,r){return process.env[e]||r}}),f={db:{port:l.pipe(((null==(t=e.db)?void 0:t.port)||3306)+"|toInt"),host:l.pipe((null==(n=e.db)?void 0:n.host)||""),database:l.pipe((null==(i=e.db)?void 0:i.database)||""),user:l.pipe((null==(o=e.db)?void 0:o.user)||""),password:l.pipe((null==(s=e.db)?void 0:s.password)||""),ssl:e.db.ssl},folder:l.pipe(e.folder||""),table:l.pipe(e.table||""),silent:!0===e.silent||!1!==e.silent&&l.pipe(e.silent||"false|toBool")};return c.parse(f)}catch(e){return console.error(e),null}},e}();S.fileName="./hashmig.config.json";var M=new t,T=/*#__PURE__*/function(){function e(){var e=this,t=this,n=this,i=this,o=this;this.hashmig=void 0,this.logger=void 0,this.isInteractive=!0,this.debug=!1,this.main=function(){try{return M.name("hashmig").description("CLI migrations tool for MySQL stored procedures and functions").version("1.0.4").option("-c, --config <string>","Path to config file","./hashmig.config.json").hook("preAction",function(r){var t=r.opts();e.init(t.config)}),M.addHelpText("after","\n\nTo configure, you can use `./hashmig.config.json` (see `./hashmig.example.config.json`) file or the following environment variables:\n  DB_PORT - post number\n  DB_SERVER - server address\n  DB_SELECT - database name\n  DB_USERNAME - username\n  DB_PASSWORD - password\n  HASHMIG_FOLDER - path to folder with migrations\n  HASHMIG_TABLE - name of table with migrations\n  HASHMIG_SILENT - disable logger"),M.command("run").description("Execute migrations").option("-n, --noninteractive","Non-interactive mode",!1).option("-d, --debug","Debug mode",!1).action(function(r){var t=r.noninteractive,n=r.debug,i=void 0!==n&&n;e.isInteractive=!(void 0!==t&&t),e.debug=i;try{return Promise.resolve(e.createMigrationsTableExists()).then(function(r){return r||process.exit(0),Promise.resolve(e.createMigrationFolder()).then(function(t){function n(r){return Promise.resolve(e.runMigrations()).then(function(){process.exit(0)})}return(r=t)||process.exit(0),e.isInteractive?Promise.resolve(e.initMigrations()).then(n):n()})})}catch(e){Promise.reject(e)}}),M.command("clear").description("Clear folder and table").action(function(){try{return Promise.resolve(r({type:"toggle",name:"value",message:"Are you sure to delete table and folder?",initial:!0,active:"yes",inactive:"no"})).then(function(r){return r.value||process.exit(0),Promise.resolve(e.hashmig.clear()).then(function(){})})}catch(e){Promise.reject(e)}}),M.command("init").description("Fill table and folder by existing stored procedures and functions").action(function(){try{return Promise.resolve(e.createMigrationsTableExists()).then(function(r){return r||process.exit(0),Promise.resolve(e.createMigrationFolder()).then(function(t){return(r=t)||process.exit(0),Promise.resolve(e.initMigrations(!0)).then(function(){})})})}catch(e){Promise.reject(e)}}),M.parse(),Promise.resolve()}catch(e){return Promise.reject(e)}},this.createMigrationsTableExists=function(){try{return Promise.resolve(t.hashmig.isMigrationsTableExists()).then(function(e){return!!e||Promise.resolve(t.hashmig.createMigrationsTable()).then(function(){return t.logger.success("--- Migration table created"),!0})})}catch(e){return Promise.reject(e)}},this.createMigrationFolder=function(){try{return n.hashmig.isMigrationsFolderExists()||(n.hashmig.createMigrationsFolder(),n.logger.success("--- Migration folder created")),Promise.resolve(!0)}catch(e){return Promise.reject(e)}},this.initMigrations=function(e){void 0===e&&(e=!1);try{return Promise.resolve(i.hashmig.getMigrations()).then(function(t){if(e||!(t.length>0))return Promise.resolve(r({type:"toggle",name:"value",message:"Would you like to initialize migrations by existing stored procedures and functions it?",initial:!0,active:"yes",inactive:"no"})).then(function(e){if(e.value)return Promise.resolve(i.hashmig.getFunctions()).then(function(e){return Promise.resolve(r({type:"multiselect",name:"value",message:"Select functions",choices:e.map(function(e){return{title:e.Name,value:e.Name,selected:!0}})})).then(function(e){var t=e.value;return Promise.resolve(i.hashmig.getProcedures()).then(function(e){return Promise.resolve(r({type:"multiselect",name:"value",message:"Select procedures",choices:e.map(function(e){return{title:e.Name,value:e.Name,selected:!0}})})).then(function(e){var r=e.value;function n(){var e=function(){if(t.length>0)return Promise.resolve(i.hashmig.initFunctions(t)).then(function(){i.logger.success("--- Migration for functions initialized")})}();if(e&&e.then)return e.then(function(){})}var o=function(){if(r.length>0)return Promise.resolve(i.hashmig.initProcedures(r)).then(function(){i.logger.success("--- Migration for procedures initialized")})}();return o&&o.then?o.then(n):n()})})})});i.logger.error("--- Migrations don't initialized")})})}catch(e){return Promise.reject(e)}},this.runMigrations=function(){try{return Promise.resolve(o.hashmig.getMigrationsToRun(o.debug)).then(function(e){var t;function n(n){return t?n:Promise.resolve(r({type:"multiselect",name:"value",message:"Select files to run",choices:Array.from(e.values()).map(function(e){return{title:e,value:e,selected:!0}})})).then(function(e){var r=e.value;if(0!==r.length)return Promise.resolve(o.hashmig.runMigrations(r)).then(function(){o.logger.success("--- Migrations completed")});o.logger.error("--- No one file selected")})}if(0!==e.size){var i=function(){if(!o.isInteractive)return Promise.resolve(o.hashmig.runMigrations(Array.from(e.values()))).then(function(){o.logger.success("--- Migrations completed"),t=1})}();return i&&i.then?i.then(n):n(i)}o.logger.success("--- All migrations already completed")})}catch(e){return Promise.reject(e)}},this.logger=new d,this.hashmig=new v}return e.prototype.init=function(e){var r=S.getConfig(e);r||(console.log("Config not found"),process.exit(1)),this.hashmig=new v(l({},r,{silent:!1}))},e}();!function(){try{return(new T).main()}catch(e){Promise.reject(e)}}();
//# sourceMappingURL=hashmig.mjs.map
